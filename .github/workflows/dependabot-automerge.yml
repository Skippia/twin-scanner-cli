# name: Dependabot auto-merge

# on: pull_request

# permissions:
#   contents: write
#   pull-requests: write

# jobs:
#   dependabot:
#     runs-on: ubuntu-latest
#     if: github.event.pull_request.user.login == 'dependabot[bot]'
#     steps:
#       - name: Fetch Dependabot metadata
#         id: metadata
#         uses: dependabot/fetch-metadata@v2
#         with:
#           github-token: '${{ secrets.GITHUB_TOKEN }}'
#       - name: Enable auto-merge for Dependabot PRs
#         if: contains(steps.metadata.outputs.update-type, 'version-update:semver-patch')
#         run: gh pr merge --auto --merge "$PR_URL"
#         env:
#           PR_URL: ${{ github.event.pull_request.html_url }}
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Dependabot auto-merge with conflict resolution

on: pull_request

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]' && contains(steps.metadata.outputs.update-type, 'version-update:semver-patch')
    steps:
      - name: Checkout master branch
        uses: actions/checkout@v3
        with:
          ref: master
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Fetch PR branch
        run: |
          # Fetch the PR branch using gh CLI.
          gh pr checkout ${{ github.event.pull_request.number }}
      - name: Merge PR with "theirs" strategy
        run: |
          # Set up git config for commit author.
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Merge the checked-out PR branch into master using the recursive strategy and favoring "their" changes.
          git merge -X theirs ${{ github.head_ref }} -m "Auto-merged Dependabot PR #${{ github.event.pull_request.number }} with conflict resolution (accepting PR changes)"
      - name: Push merge to master
        run: |
          git push origin master
